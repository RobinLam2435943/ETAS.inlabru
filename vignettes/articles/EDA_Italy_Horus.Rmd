---
title: "Exploratory Data Analysis: Italian Earthquake Catalogue - Horus"
author: "Mark Naylor"
date: "2023-06-27"
output: html_document
---

```{r setup0, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png",
  dev.args = list(type = "cairo-png"),
  echo = TRUE
)
```

## Load Packages

```{r setup, include=TRUE,message=FALSE,warning=FALSE}
library(ETAS.inlabru)
library(ggplot2)

library(rnaturalearth)
library(lubridate)
library(raster)
library(sf)
library(sp)
library(ggspatial)
library(rnaturalearthdata)

## This is just the EPSG equivalent of WGS84
crs_wgs84 <- CRS(SRS_string='EPSG:4326')

```

# Load an earthquake catalogue

Earthquake data is stored in the so-called earthquake catalogues. Many different catalogues exists for the same region and there is no easy way to decide which one is better. Here, we provide the HOmogenized instRUmental Seismic (HORUS) catalogue from 1960 to 2020. It can be downloaded from [http://horus.bo.ingv.it/](http://horus.bo.ingv.it/).
A subset (see [data-raw/horus.R](https://github.com/edinburgh-seismicity-hub/ETAS.inlabru/blob/main/R/AnalysingPosteriors.R) for how the the subset was created)
of the information in the Horus catalogue can be loaded using

```{r}
# load ISIDE catalogue
data(horus, package = "ETAS.inlabru")

# transform time string in Date object
time_string <- gsub("T", " ", horus$time_string)
horus$time_date <- as.POSIXct(time_string,
  format = "%Y-%m-%d %H:%M:%OS"
)

head(horus)

df_cat <- horus

# add event number
df_cat$event_num <- seq.int(nrow(df_cat))

# sp version of the catalogue
df_cat.sp <- data.frame(df_cat)
sp::coordinates(df_cat.sp) <- c("lon", "lat")
crs_wgs84 <- CRS(SRS_string='EPSG:4326')
proj4string(df_cat.sp) <- crs_wgs84

# sf version of the catalogue
df_cat.sf<- st_as_sf(df_cat.sp)


```

The data reports for each earthquake the longitude (`lon`) and latitude (`lat`) of the epicentre, the moment magnitude (`M`), the time as a string (`time_string`), the depth in kilometres (`depth`), and a catalogue and event IDs.   


# Whole Italy EDA

# Get map and extract crs for the map

```{r}
italy.map <- ne_countries(country = 'Italy', returnclass = "sf", scale = 'medium')
italy.crs <- crs(italy.map)

ggplot() + geom_sf(data = italy.map) + theme_bw()
```

# EDA for the whole Mediteranian catalogue

## Histogram of event depths

```{r}
hist(df_cat$depth, breaks=seq(650,-5,-1), xlim=c(-5,40), main="Histogram of depths" )
```


```{r Depth histogram, eval=FALSE, include=FALSE}
ggplot(df_cat, aes( x="depth" )) + 
  geom_histogram( ) + 
  coord_flip (xlim = c(350, 0) ) +
  ggtitle("Hight res. histogram of event depths for depth inversion aretfacts")
```

## Plot of event magnitudes using natural time

```{r}
ggplot(df_cat, aes(x=event_num, y=M))  + geom_point(size = 0.1) 
```

## Plot of event magnitudes using date-time

```{r Magnitude natural-time series}
ggplot(df_cat, aes(x=time_date, y=M)) + 
  geom_point(size = 0.1) +
  ggtitle("Horus catalogue magnitude time series")
```

```{r Magnitude time series}
# Filtered for M>4
ggplot(df_cat[df_cat$M>4,], aes(x=time_date, y=M)) + 
  geom_point(size = 0.1) +
  ggtitle("Whole catalogue magnitude timeseries for M>4")

```

## Frequency-magnitude analysis for Horus catalogue

```{r National GR Plot}
minMag <- 3
maxMag <- max(df_cat$M)

mags <- df_cat[df_cat$M>minMag,]$M

tmp <- hist(mags, breaks=seq(minMag-0.05,maxMag+0.1,0.1), plot=FALSE)

N.counts <- length( tmp$counts)
tmp$cumulativeCounts <- cumsum(tmp$counts[N.counts:1])[N.counts:1]

m.min <- 4
bin_m.min <- which(tmp$mids==m.min)
freq_m.min <- tmp$counts[bin_m.min]
b <- 1.1
x <- tmp$mids
y <- freq_m.min * 10^(-b*(x-m.min))
y.cum <- tmp$cumulativeCounts[bin_m.min] * 10^(-b*(x-m.min))

ggplot() +
  geom_point( aes(x=tmp$mids, y=tmp$counts) ) +
  geom_point( aes(x=tmp$mids, y=tmp$cumulativeCounts) , color='red', pch="+", size=2) +
  scale_y_log10() +
  ggtitle(paste("Frequency-magnitude plot with arbitary GR dist: b =", b)) +
  xlab("Magnitude") +
  ylab("log10(Frequency)") +
  geom_line(aes(x=x, y=y)) +
  geom_line(aes(x=x, y=y.cum), color='red') +
  geom_vline( xintercept=m.min, lty=2 )

```

## b-value stability plot for the events in the Horis catalogue

```{r National b-value stability}

minMag <- 0
maxMag <- max(df_cat$M, na.rm=TRUE)
mags <- df_cat[df_cat$M>=minMag,]$M

x <- seq(minMag,maxMag,0.1)

b.stability.list <- c()
b.error.list <- c()
m.mean <- c()

b_utsu <- c()
b_guttorp <- c()
b_elst <- c()
delta_b_utsu <- c()
b_elst_lower <- c()
b_elst_upper <- c()

max.index.x <- length(x)-5

for( i in 1:max.index.x ){
  mag.threshold <- x[i]
  print(mag.threshold)
  mags.subset <- mags[mags > mag.threshold]
  
  N <- length(mags.subset)
  b_utsu[i] <- 1/( log(10)*(mean(mags.subset)-mag.threshold+0.05))
  delta_b_utsu[i] <- log(10)*b_utsu[i]**2 * sqrt( sum((mags.subset - mean(mags.subset))**2)/(N*(N-1)))
    
  b_guttorp[i] = 1/( 2*0.05*log(10))*log((mean(mags.subset)-mag.threshold+2*0.05)/(mean(mags.subset)-mag.threshold))
    
  deltaMags <- diff(mags.subset)
  deltaMags_p <- deltaMags[deltaMags>0.1]
  N <- length(deltaMags_p)
  b_elst[i] <- 1/(2*0.05* log(10)) * log((mean(deltaMags_p))/(mean(deltaMags_p)-0.1))
  c = 10**(0.1*b_elst[i])
  b_elst_lower[i] <- 1/(0.1 * log(10)) * log((c+sqrt(c/N))/(1+sqrt(c/N)))
  b_elst_upper[i] <- 1/(0.1 * log(10)) * log((c-sqrt(c/N))/(1-sqrt(c/N)))
}

ggplot() +
  geom_line( aes(x=x[1:max.index.x], y=b_utsu) ) +
  geom_line( aes(x=x[1:max.index.x], y=b_utsu+delta_b_utsu), color=2, lty=2 ) +
  geom_line( aes(x=x[1:max.index.x], y=b_utsu-delta_b_utsu), color=2, lty=2 ) +
  geom_line( aes(x=x[1:max.index.x], y=b_guttorp), color=3, lty=1 ) +
  xlab("Magnitude threshold") +
  ylab("b-value estimate") +
  geom_hline(yintercept = 1, lty=3) +
  geom_hline(yintercept = 0.85, lty=3) +
  ggtitle("b-value stability plot for Horus catalogue")
```

## Heatmap of the events in the Horus catalogue

```{r hexbin event density}
ggplot() +
  geom_hex(data = df_cat[df_cat$M>3,], aes(x = lon, y = lat), bins = 50) +
  scale_fill_continuous(type = "viridis") +
  geom_sf(data = italy.map, fill=alpha("lightgrey", 0), color = 'orange', size=0.2) + 
  ggtitle("Density plot for M>3 events") +
  theme_bw()
```

## Map of the events in the Italian Horus catalogue

```{r map of locations}
ggplot() +
  geom_sf(data = df_cat.sf[df_cat$M>3,], size = 0.05) +
  geom_sf(data = italy.map, fill=alpha("lightgrey", 0), color = 'green', linewidth=0.7) +
  geom_sf(data = df_cat.sf[df_cat$M>5,], size = 0.5, color='orange') +
  geom_sf(data = df_cat.sf[df_cat$M>6,], size = 0.5, color='red') +
  ggtitle("Map of event locations")
```
# L'Aquila Sequence

To focus on the L'Aquila seismic sequence is sufficient to retain only the observations in a specific space-time-magnitude region that include the sequence of interest. For the L'Aquila sequence, we retain all the events with magnitude greater or equal than $2.5$ happened during 2009 with longitude in $(10.5, 16)$ and latitude in $(40.5, 45)$. The L'Aquila sequence selected in this way should be composed by 1024 events. Any other seismic sequence can be selected similarly.

To do the selection is convenient to transform the time string in a `Date` object and to select the rows of the Horus catalogue verifying the conditions.

start.date = "2009-04-06 00:00:00 BST"
end.date = "2010-01-01 00:00:00 BST"
magnitude.completeness = 2.49
min.longitude = 13.00
max.longitude = 13.75
min.latitude = 42.2
max.latitude = 42.5 

```{r Extract l'Aquila subset}
eventDate <- ymd_hms( '2009-04-06 00:00:00 BST' )
endDate <- eventDate + days(400)
startDate <- eventDate - days(50)
deltaLat <- 2.4
latLims <- c( 42.2,42.5)
longLims <- c( 13, 13.75)

minMAG <- 0

# Subset the main catalogue
df_cat.subset <- df_cat[df_cat$M >= minMAG, ]
df_cat.subset <- df_cat.subset[ (df_cat.subset$lat>latLims[1]), ]
df_cat.subset <- df_cat.subset[ (df_cat.subset$lat<latLims[2]), ]
df_cat.subset <- df_cat.subset[ (df_cat.subset$lon>longLims[1]), ]
df_cat.subset <- df_cat.subset[ (df_cat.subset$lon<longLims[2]), ]

head(df_cat.subset)
```
## Plot of the event magnitude time series: l'Aquila

```{r}
ggplot() + 
  geom_point(data=df_cat.subset[df_cat.subset$M>3,], aes(time_date, lat), size=0.1) +
  geom_point(data=df_cat.subset[df_cat.subset$M>5,], aes(time_date, lat), size=1.2, color='orange') +
  geom_point(data=df_cat.subset[df_cat.subset$M>6,], aes(time_date, lat), size=1.5, color='red') +
  ggtitle("L'Aquila latitude-time plot") +
  geom_rect(aes(xmin = as.POSIXct(startDate), xmax = as.POSIXct(endDate), ymin = latLims[1], ymax = latLims[2]), alpha = 0.4, fill='blue', color='blue')
```

```{r regional GR Plot}
minMag <- 0
maxMag <- max(df_cat.subset$M, na.rm=TRUE)

mags <- df_cat.subset[df_cat.subset$M>=minMag,]$M

tmp <- hist(mags, breaks=seq(minMag-0.05,maxMag+0.4,0.1), plot=FALSE)

N.counts <- length( tmp$counts)
tmp$cumulativeCounts <- cumsum(tmp$counts[N.counts:1])[N.counts:1]

m.min <- 4
bin_m.min <- which(tmp$mids==m.min)
freq_m.min <- tmp$counts[bin_m.min]
b <- 1.
x <- tmp$mids
y <- freq_m.min * 10^(-b*(x-m.min))
y.cum <- tmp$cumulativeCounts[bin_m.min] * 10^(-b*(x-m.min))

ggplot() +
  geom_point( aes(x=tmp$mids, y=tmp$counts) ) +
  geom_point( aes(x=tmp$mids, y=tmp$cumulativeCounts) , color='red', pch="+") +
  scale_y_log10() +
  ggtitle(paste("Frequency-magnitude plot with arbitary GR dist: b =", b)) +
  xlab("Magnitude") +
  ylab("log10(Frequency)") +
  geom_line(aes(x=x, y=y)) +
  geom_line(aes(x=x, y=y.cum), color='red') +
  geom_vline( xintercept=m.min, lty=2 )

```

## b-value stability plot: l'Aquila

```{r}

minMag <- 0
maxMag <- max(df_cat.subset$M, na.rm=TRUE)
mags <- df_cat.subset[df_cat.subset$M>=minMag,]$M

x <- seq(minMag,maxMag,0.1)

b.stability.list <- c()
b.error.list <- c()
m.mean <- c()

b_utsu <- c()
b_guttorp <- c()
b_elst <- c()
delta_b_utsu <- c()
b_elst_lower <- c()
b_elst_upper <- c()

max.index.x <- length(x)-5

for( i in 1:max.index.x ){
  mag.threshold <- x[i]
  print(mag.threshold)
  mags.subset <- mags[mags > mag.threshold]
  
  N <- length(mags.subset)
  b_utsu[i] <- 1/( log(10)*(mean(mags.subset)-mag.threshold+0.05))
  delta_b_utsu[i] <- log(10)*b_utsu[i]**2 * sqrt( sum((mags.subset - mean(mags.subset))**2)/(N*(N-1)))
    
  b_guttorp[i] = 1/( 2*0.05*log(10))*log((mean(mags.subset)-mag.threshold+2*0.05)/(mean(mags.subset)-mag.threshold))
    
  deltaMags <- diff(mags.subset)
  deltaMags_p <- deltaMags[deltaMags>0.1]
  N <- length(deltaMags_p)
  b_elst[i] <- 1/(2*0.05* log(10)) * log((mean(deltaMags_p))/(mean(deltaMags_p)-0.1))
  c = 10**(0.1*b_elst[i])
  b_elst_lower[i] <- 1/(0.1 * log(10)) * log((c+sqrt(c/N))/(1+sqrt(c/N)))
  b_elst_upper[i] <- 1/(0.1 * log(10)) * log((c-sqrt(c/N))/(1-sqrt(c/N)))
}

ggplot() +
  geom_line( aes(x=x[1:max.index.x], y=b_utsu) ) +
  geom_line( aes(x=x[1:max.index.x], y=b_utsu+delta_b_utsu), color=2, lty=2 ) +
  geom_line( aes(x=x[1:max.index.x], y=b_utsu-delta_b_utsu), color=2, lty=2 ) +
  geom_line( aes(x=x[1:max.index.x], y=b_guttorp), color=3, lty=1 ) +
  xlab("Magnitude threshold") +
  ylab("b-value estimate") +
  geom_hline(yintercept = 1, lty=3) +
  geom_hline(yintercept = 0.85, lty=3) +
  ggtitle("b-value stability plot for Horus catalogue")
```

